<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Console</title>
</head>
  <script src="pixi/pixi.min.js"></script>
  <script src="pixi/pixi-sound.js"></script>
<body>
  <body bgcolor="#222222">

  <script type="text/javascript">
    let type = "WebGL"
    if(!PIXI.utils.isWebGLSupported()){
      type = "canvas"
    }

	let state;
	
	var app = new PIXI.Application(800,600,{backgroundColor: 0x0} );
	document.body.appendChild(app.view);
	
	// The console main style
	var style = new PIXI.TextStyle({
	    fontFamily: 'asimov',
	    fontSize: 20,
	    fontStyle: 'normal',
	    fontWeight: 'bold',
//	    fill: ['#FFFF30', '#AAAA10'], // gradient
	    fill: ['#FFFF28', '#AAAAff'], // gradient
	    stroke: '#4a1850',
	    strokeThickness: 0,
	    dropShadow: false,
	    dropShadowColor: '#000000',
	    dropShadowBlur: 0,
	    dropShadowAngle: 1,
	    dropShadowDistance: 6,
	    wordWrap: true,
	    wordWrapWidth: 740
	});

	// Console input line
	const PS1 = "> ";
	var promptText = new PIXI.Text("The Map", style);
	promptText.x = 30;
	promptText.y = 400;

    const img1 = ['img/black.jpg',0.5,0.5];
    const img2 = ['img/blackglass.png',0.45,0.5];
    const img3 = ['img/Layer1.png',0.5,0.5];
    const img4 = ['img/white.jpg',0.5,0.5];
    const img5 = ['img/white2.jpg',0.5,0.5];
    
    let backgroundimg = new PIXI.Sprite.fromImage(img4[0]);    
    //backgroundimg.setTransform(0,0,img3[1],img4[2]);
   

 
	var graphics = new PIXI.Graphics();

	// set a fill and line style
	
	
    // Add elements to canvas
	app.stage.addChild(promptText);
	//app.stage.addChild(backgroundimg);
	app.stage.addChild(graphics);
		
    //Set the game state
    state = play;
 	const WHITE = 0xFFFFFF;
	xi = 10;
	yi = 10;
	color = WHITE;
	
	// Define the map
	function Map(size) {
	  this.width = size;
	  this.height = size;
	  this.assignedgraphics = undefined;
	  this.assignedscale = 3;
	  this.initcolor = 128;
	  this.val = new Array(this.width); 
      for (var i = 0; i < this.width; i++) {
        this.val[i] = new Array(this.height);
      }
	}
	
    Map.prototype.init = function() {
	  for (i=0; i<this.width; i++) {
	    for (j=0; j<this.height; j++) {
		  this.set(i,j,this.initcolor);
        }
      }    	    
	}

    Map.prototype.fillrandom = function() {
	  for (i=0; i<this.width; i++) {
	    for (j=0; j<this.height; j++) {
		  var randval = Math.floor((Math.random()*255));
		  var greycol = randval  ; //+ randval*256 + randval * 65536;
		  this.set(i,j,greycol);
        }
      }    	    
	}	

	Map.prototype.draw = function(x,y) {
	  scale = this.assignedscale;
	  graph = this.assignedgraphics;
	  for (i=0; i<this.width; i++) {
	    for (j=0; j<this.height; j++) {
	      value = this.get(i,j);
		  drawpix(x+(i*scale),y+(j*scale),value+value*0x000100+value*0x010000,scale,graph);
        }
      }    	 
    }
    
    Map.prototype.set = function(x,y,value) {
	  if ((x>=0) && (y>=0) && (x<this.width) && (y<this.height)) {
    	  this.val[x][y] = value;
	  }   
	}

    Map.prototype.get = function(x,y) {
	  if ((x>=0) && (y>=0)&& (x<this.width) && (y<this.height)) {
	    return this.val[x][y];}
	    else return 0;   
	}
	
	// Looks better finally
    Map.prototype.changeh = function(x,y,offset) {
	    var radius = Math.abs(offset); // Math.abs(this.get(x,y) - offset);
	    for (i=(-radius); i<(radius+1); i++) {
		    for (j=(-radius); j<(radius+1); j++) {
		        dist = Math.sqrt(i*i+j*j);
		        
		        // cubic distribution
		        //if (dist==0) {variation = offset;} else {
				//	variation = (offset/dist>>0);} // This gives the integer part of the division
		        
		        // linear distribution
				variation = (offset-dist>>0);
				if (variation <0) {variation =0;} // This gives the integer part of the division
		        
		        oldval = this.get(x+i,y+j);
		        newval = oldval+variation;
		        if (newval>255) {newval=255;}
		        if (newval<0) {newval =0;}
		        if (newval != oldval) {
					this.set(x+i,y+j,newval);
		            this.drawpoint(x+i,y+j);
				}
				
	            //this.set(x+i,y+j,this.get(x+i,y+j)+offset);
	        }
        }
    }
    
    Map.prototype.drawpoint = function(x,y) {
      scale = this.assignedscale;
	  graph = this.assignedgraphics;
	  value = this.get(x,y);
	  drawpix(x*scale,y*scale, value+value*0x000100+value*0x010000,scale,graph);
    }
    
    
    // Recursive function to change height // Bad idea :(
    Map.prototype.changeh2 = function(x,y,offset) {

	   // here we have to put a STOP condition to the recursivity calls when offset is under 1
       if (offset < 1) { return "ZERO";}
       if (offset == 1) {
		 this.set(x,y, this.get(x,y) + 0x111100);// Change the value of the map
		 this.drawpoint(x,y);
		 return "ONE";  
	   } else {
		   offset = Math.trunc(offset);
		   nextoff = offset - 1;
		   diagoff = nextoff * 0.7;
	       
	       this.changeh2(x-1,y-1,diagoff);
	       this.changeh2(x  ,y-1,nextoff);
	       this.changeh2(x+1,y-1,diagoff);
	       
	       this.changeh2(x-1,y,nextoff);
	       this.set(x  ,y,this.get(x,y) + offset*0x111100); // Change the value of the map
	       this.drawpoint(x,y);
	       this.changeh2(x+1,y,nextoff);
	       
	       this.changeh2(x-1,y+1,diagoff);
	       this.changeh2(x  ,y+1,nextoff);
	       this.changeh2(x-1,y+1,diagoff);  
	       }	    		        
    }	
	
	
    var mapx = 0;
    var mapy = 0;
	map = new Map(150);
	map.assignedgraphics=graphics;
	map.assignedscale=3;
	map.init();
	//map.fillrandom();
    map.draw(mapx,mapy,3,graphics);
    
    
    // Mouse
    document.addEventListener("click", mouseclick);
    document.addEventListener("mouseup", mouseup);
    document.addEventListener("mousedown", mousedown);
    function mouseclick() {console.log("Click");}
    function mouseup() {console.log("up");}
    function mousedown() {console.log("down");}
    
    
    var themouse = app.renderer.plugins.interaction.mouse;
    
    //Start the game loop 
    app.ticker.add(delta => gameLoop(delta));
    
	function gameLoop(delta){
	  //Update the current game state:
	  state(delta);
	}
	

	
	// MainLoop
	function play(delta) {
	  x = themouse.global.x/3>>0; y= themouse.global.y/3>>0;	
	  if (themouse.buttons == 1) {
		  //for (i=-2; i<5; i++) {
			  //for (j=-2; j<5; j++) {
				  //val = map.get(x+i,y+j);
			      //newcol = val + (4-Math.abs(j)-Math.abs(i))*0x010101;
			      //map.set(x+i,y+j,newcol);
			  //}
		 //}
		  //drawpix(x,y,WHITE,3,graphics);
		  //map.changeh2(x,y,20);
		  map.changeh(x,y,40);
		  
		  //map.set(x,y,map.get(x,y)+0x111100);
		  //map.drawpoint(x,y);
          //map.draw(mapx,mapy);        
	  }
	  
      var mousePosition = app.renderer.plugins.interaction.mouse.global;
      promptText.text = themouse.buttons;
		
      //map.draw(xi,yi,graphics);	
      //xi = xi + 50;
      //if (xi > 500) { xi = 0; yi = yi +50;}
      //if (yi > 500) {yi = 0; map.initcolor = map.initcolor - 64; map.init()}   
      //map.initcolor = map.initcolor - 64; map.init()
	}
    
	function win(delta) {
		
	}

	function lose(delta) {
		
	}

	function pixel() {
	this.x = 0;
	this.y = 0;
	this.val = 0xFFFFFF;	
	}
	
	pixel.prototype.set = function(x,y) {
	  this.x = x;
	  this.y = y;
	}

    function drawpix(x,y,color,scale,graph) {
	  graph.beginFill(color, 1);
	  graph.drawRect(x-(scale/2),y-(scale/2),scale,scale);
    }
  </script>
</body>
</html>
